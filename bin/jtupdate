#!/bin/bash
TARGET="-mist -mister -sidi"
EXTRA="-d JTFRAME_RELEASE -g"
NETWORK=

# Biocom is currently ommited
cores="1942 1943 gng commando gunsmoke vulgus tora f1dream btiger sectionz"


while [ $# -gt 0 ]; do
    case "$1" in
        -mister)
            TARGET=-mister;;
        -mist)
            TARGET=-mist;;
        -sidi)
            TARGET=-sidi;;
        -target)
            shift
            TARGET=
            for i in $1; do
                TARGET="$TARGET -$i"
            done
            ;;
        -all | -a)
			TARGET="-mist -mister -sidi";;
        -test)
            EXTRA="-d NOSOUND -d MISTER_NOHDMI";;
        -cores)
            shift
            cores="$1";;
        -network)
            if [ "$TARGET" = "-mister" ]; then
                NETWORK="-S 1/portatil.home -S 2/despacho.home"
            else
                NETWORK="-S 2/portatil.home -S 8/despacho.home"
            fi
            ;;
        -h | -help | --help)
            cat <<EOF
Updates all JT cores. Usage:
    jtupdate    update MiST target by default

    -mist   updates MiST target (uses all CPU cores, paralel compilation)
    -mister updates MiSTer target (one JT core at a time)
    -all    updates both MiST and MiSTer
    -cores  list of cores to update as \"gng 1943\"
    -sidi   compile for SiDi. Cannot update for SiDi and MiST at the same time
    -test   test build. Disables sound and HDMI. Does not define JTFRAME_RELEASE.
    :       options for jtcore script can be added after a colon
EOF
        exit 0;
        ;;
        :)
            # the remaining argument will be passed directly to the compilation
            shift
            EXTRA="$EXTRA $*"
            break;;
        *)  echo "ERROR: jtupdate does not know option $1";
            exit 1;;
    esac
    shift
done

PARA=

#if [ "$TARGET" = -mister ]; then
#    PARA="$PARA --jobs 2"
#fi
export JTROOT
#parallel $NETWORK $PARA $JTFRAME/bin/jtcore {} $EXTRA ::: $cores ::: $TARGET | tee update.log
parallel $NETWORK $PARA $JTFRAME/bin/jtcore {} $EXTRA ::: $cores ::: $TARGET | tee $JTROOT/log/update.log
